!function(){"use strict";var t,e,n=5120,i=4350,o=function(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var i=Array(t),o=0;for(e=0;e<n;e++)for(var a=arguments[e],s=0,r=a.length;s<r;s++,o++)i[o]=a[s];return i},a=function(){function t(){}return t.prototype.createCanvas=function(){var t;return this.canvas=document.getElementById("canvas"),this.context=null===(t=this.canvas)||void 0===t?void 0:t.getContext("2d"),this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.canvas},t.prototype.drawField=function(t){var e=this;this.context.clearRect(0,0,window.innerWidth,window.innerHeight);var n=t.currentPlayer;this.drawBackground(n.position.x,n.position.y),t.food.forEach((function(t){e.drawBall(n,t)})),t.enemies.forEach((function(t){e.drawBall(n,t)})),this.drawBall(n,n),this.drawBorder(n)},t.prototype.drawBorder=function(t){this.context.beginPath(),this.context.strokeStyle="black",this.context.lineWidth=5,this.context.strokeRect(this.canvas.width/2-t.position.x,this.canvas.height/2-t.position.y,n,i)},t.prototype.drawBackground=function(t,e){var a=this;o(new Array(100)).forEach((function(o,s){var r={x:s*n/100-t+a.canvas.width/2,y:0-e+a.canvas.height/2},c={x:s*n/100-t+a.canvas.width/2,y:i-e+a.canvas.height/2};a.drawBackgroundNetLine(r,c)})),o(new Array(80)).forEach((function(o,s){var r={x:0-t+a.canvas.width/2,y:s*i/80-e+a.canvas.height/2},c={x:n-t+a.canvas.width/2,y:s*i/80-e+a.canvas.height/2};a.drawBackgroundNetLine(r,c)}))},t.prototype.drawBackgroundNetLine=function(t,e){this.context.beginPath(),this.context.moveTo(t.x,t.y),this.context.lineTo(e.x,e.y),this.context.strokeStyle="#a3e3b4",this.context.lineWidth=1,this.context.stroke()},t.prototype.drawBall=function(t,e){var n=this.canvas.width/2+e.position.x-t.position.x,i=this.canvas.height/2+e.position.y-t.position.y;this.context.save(),this.context.translate(0,0),this.context.beginPath(),this.context.arc(n,i,e.radius,0,2*Math.PI),e.name&&(this.context.strokeStyle="black",this.context.lineWidth=4,this.context.stroke(),this.context.textAlign="center",this.context.textBaseline="middle",this.context.font="bold 18px Arial",this.context.fillText(e.name,n,i-e.radius-10)),this.context.fillStyle=e.color,this.context.fill(),this.context.restore()},t}(),s=function(){function t(){this.isConnectionReady=!1,this.messagesQueue=[]}return t.prototype.createConnection=function(){this.connection=new WebSocket("https://agar-io-ws-server.herokuapp.com/"),this.handleConnectionOpening()},t.prototype.handleConnectionOpening=function(){var t=this;this.connection.addEventListener("open",(function(){t.isConnectionReady=!0,t.messagesQueue.forEach((function(e){return t.sendMessage(e)}))}))},t.prototype.sendMessage=function(t){var e;this.isConnectionReady?null===(e=this.connection)||void 0===e||e.send(JSON.stringify(t)):this.messagesQueue.push(t)},t.prototype.addMessageHandler=function(t){var e;null===(e=this.connection)||void 0===e||e.addEventListener("message",(function(e){var n=e.data;t(JSON.parse(n))}))},t}();!function(t){t.CHANGE_DIRECTION="change_direction",t.START_GAME="start_game"}(t||(t={})),function(t){t.UPDATE_FIELD="update_field",t.FINISH_ROUND="finish_round",t.START_NEW_ROUND="start_new_round",t.GAME_OVER="game_over",t.NEW_FOOD="new_food"}(e||(e={}));var r=function(){function e(t){this.websocketService=t}return e.prototype.startMonitoringInput=function(t){this.mouseInputHandler=this.onMouseInput.bind(this,t),t.addEventListener("mousemove",this.mouseInputHandler)},e.prototype.stopMonitoringInput=function(t){t.removeEventListener("mousemove",this.mouseInputHandler)},e.prototype.onMouseInput=function(t,e){var n=e.clientX,i=e.clientY,o=t.getBoundingClientRect(),a=(n-o.left)/(o.right-o.left)*t.width,s=(i-o.top)/(o.bottom-o.top)*t.height;this.handleInput(a,s)},e.prototype.handleInput=function(e,n){var i=Math.atan2(e-window.innerWidth/2,window.innerHeight/2-n);this.websocketService.sendMessage({type:t.CHANGE_DIRECTION,data:{direction:i}})},e}(),c=function(){function t(t,e,n,i,o,a){this.websocketService=t,this.inputService=e,this.fieldService=n,this.startGamePopup=i,this.gameOverPopup=o,this.roundEndedPopup=a}return t.prototype.startGame=function(){this.websocketService.createConnection(),this.canvas=this.fieldService.createCanvas(),this.startGamePopup.handleGameStart(this.handleStartGame.bind(this))},t.prototype.handleStartGame=function(){this.handleServerUpdates(),this.startMonitoringInput()},t.prototype.startMonitoringInput=function(){this.inputService.startMonitoringInput(this.canvas)},t.prototype.endMonitoringGame=function(){this.inputService.stopMonitoringInput(this.canvas)},t.prototype.handleServerUpdates=function(){var t=this;this.websocketService.addMessageHandler((function(n){switch(n.type){case e.UPDATE_FIELD:t.fieldService.drawField(n.data);break;case e.GAME_OVER:t.gameOverPopup.handleGameOver(t.endMonitoringGame.bind(t),t.startMonitoringInput.bind(t),t.startGamePopup.getUsername());break;case e.FINISH_ROUND:t.roundEndedPopup.handleRoundEnded(t.endMonitoringGame.bind(t),t.startMonitoringInput.bind(t),t.startGamePopup.getUsername())}}))},t}(),d=function(){function e(t){this.websocketService=t,this.startGameButton=document.getElementById("start"),this.usernameInput=document.getElementById("username"),this.notValidUsernameError=document.getElementById("notValidUsername"),this.startGamePopup=document.getElementById("startGamePopup")}return e.prototype.handleGameStart=function(e){var n=this;this.startGameButton.addEventListener("click",(function(){n.name=n.usernameInput.value,n.isUsernameValid(n.name)?(n.notValidUsernameError.style.display="hidden",n.websocketService.sendMessage({type:t.START_GAME,data:{name:n.name}}),e(),n.startGamePopup.style.display="none"):n.notValidUsernameError.style.visibility="visible"}))},e.prototype.getUsername=function(){return this.name},e.prototype.isUsernameValid=function(t){return!!t.length},e}(),u=function(){function e(t){this.websocketService=t,this.gameOverPopup=document.getElementById("gameOverPopup"),this.startNewGameButton=document.getElementById("startNewGame")}return e.prototype.handleGameOver=function(t,e,n){this.gameOverPopup.style.display="flex",t(),this.startNewGame(n,e)},e.prototype.startNewGame=function(e,n){var i=this;this.startNewGameButton.addEventListener("click",(function(){i.websocketService.sendMessage({type:t.START_GAME,data:{name:e}}),n(),i.gameOverPopup.style.display="none"}))},e}(),h=function(){function e(t){this.websocketService=t,this.roundEndedPopup=document.getElementById("roundEndedPopup"),this.startRoundButton=document.getElementById("startRound")}return e.prototype.handleRoundEnded=function(t,e,n){this.roundEndedPopup.style.display="flex",t(),this.startNewRound(n,e)},e.prototype.startNewRound=function(e,n){var i=this;this.startRoundButton.addEventListener("click",(function(){i.websocketService.sendMessage({type:t.START_GAME,data:{name:e}}),n(),i.roundEndedPopup.style.display="none"}))},e}(),p=new s,l=new c(p,new r(p),new a,new d(p),new u(p),new h(p));document.addEventListener("DOMContentLoaded",l.startGame.bind(l))}();